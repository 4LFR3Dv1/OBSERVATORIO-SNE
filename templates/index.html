<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNE - Observatório de Forças</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Courier New", monospace; background: #000; color: #00ff00; font-size: 12px; }
        .header { background: #000; padding: 10px; text-align: center; border-bottom: 1px solid #00ff00; }
        .header h1 { font-size: 18px; font-weight: normal; }
        .controls { padding: 10px; text-align: center; border-bottom: 1px solid #333; }
        .btn { background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px 10px; margin: 0 3px; cursor: pointer; font-family: "Courier New", monospace; font-size: 11px; }
        .btn:hover { background: #00ff00; color: #000; }
        .main-content { display: flex; height: calc(100vh - 120px); }
        .chart-container { flex: 2; padding: 10px; border-right: 1px solid #333; }
        .chart-title { color: #00ff00; font-size: 14px; margin-bottom: 10px; text-align: center; }
        .info-panel { flex: 1; padding: 10px; background: #000; }
        .info-section { margin-bottom: 15px; }
        .info-section h3 { color: #00ff00; font-size: 12px; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .info-item { margin-bottom: 5px; font-size: 11px; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        .status-active { background: #00ff00; }
        .status-inactive { background: #ff0000; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #00ff00; font-size: 12px; }
        #priceChart { background: #000; border: 1px solid #333; }
    </style>
</head>
<body>
    <div class="header"><h1>SNE - Observatório de Forças</h1></div>
    <div class="controls">
        <button class="btn" onclick="solicitarDados()">Atualizar</button>
        <button class="btn" onclick="toggleAutoUpdate()">Auto: ON</button>
    </div>
    <div class="main-content">
        <div class="chart-container">
            <div class="chart-title">Preços BTC/USDT</div>
            <canvas id="priceChart" width="600" height="300"></canvas>
            <div id="loading" class="loading">Conectando...</div>
        </div>
        <div class="info-panel">
            <div class="info-section">
                <h3>Status</h3>
                <div class="info-item"><span class="status-indicator" id="magneticStatus"></span><span id="magneticStatusText">Conectando...</span></div>
                <div class="info-item">Preço: <span id="currentPrice">--</span></div>
                <div class="info-item">Volume: <span id="currentVolume">--</span></div>
                <div class="info-item">Trades: <span id="currentTrades">--</span></div>
            </div>
            <div class="info-section">
                <h3>Indicadores</h3>
                <div class="info-item">EMA8: <span id="ema8">--</span></div>
                <div class="info-item">EMA21: <span id="ema21">--</span></div>
                <div class="info-item">SMA200: <span id="sma200">--</span></div>
                <div class="info-item">Densidade: <span id="densidade">--</span></div>
            </div>
            <div class="info-section">
                <h3>Última Atualização</h3>
                <div class="info-item" id="lastUpdate">--</div>
            </div>
        </div>
    </div>
    <script>
        const socket = io();
        let priceChart;
        let autoUpdate = true;
        function initializeChart() {
            const ctx = document.getElementById("priceChart").getContext("2d");
            priceChart = new Chart(ctx, {
                type: "line",
                data: { labels: [], datasets: [{ label: "BTC/USDT", data: [], borderColor: "#00ff00", backgroundColor: "rgba(0, 255, 0, 0.1)", borderWidth: 1, fill: false, tension: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: "#00ff00", font: { family: "Courier New", size: 8 } }, grid: { color: "#333" } }, y: { ticks: { color: "#00ff00", font: { family: "Courier New", size: 8 } }, grid: { color: "#333" } } } } }
            });
        }
        function updateChart(dados) {
            if (!dados || dados.length === 0) return;
            const labels = dados.map(d => new Date(d.time).toLocaleTimeString());
            const prices = dados.map(d => parseFloat(d.close));
            priceChart.data.labels = labels;
            priceChart.data.datasets[0].data = prices;
            priceChart.update("none");
            document.getElementById("loading").style.display = "none";
        }
        function updateInfoPanel(analise) {
            if (analise && analise.dados && analise.dados.length > 0) {
                const ultimo = analise.dados[analise.dados.length - 1];
                document.getElementById("currentPrice").textContent = "$" + parseFloat(ultimo.close).toFixed(2);
                document.getElementById("currentVolume").textContent = parseFloat(ultimo.volume).toFixed(2);
                document.getElementById("currentTrades").textContent = ultimo.trades;
                document.getElementById("ema8").textContent = parseFloat(ultimo.EMA8).toFixed(2);
                document.getElementById("ema21").textContent = parseFloat(ultimo.EMA21).toFixed(2);
                document.getElementById("sma200").textContent = parseFloat(ultimo.SMA200).toFixed(2);
                document.getElementById("densidade").textContent = parseFloat(ultimo.densidade).toFixed(6);
                document.getElementById("lastUpdate").textContent = new Date().toLocaleTimeString();
            }
        }
        function solicitarDados() { socket.emit("solicitar_dados"); document.getElementById("loading").style.display = "block"; }
        function toggleAutoUpdate() { autoUpdate = !autoUpdate; const btn = event.target; btn.textContent = "Auto: " + (autoUpdate ? "ON" : "OFF"); }
        function loadInitialData() {
            fetch("/api/dados").then(response => response.json()).then(data => {
                if (data.status === "sucesso" && data.dados && data.dados.length > 0) {
                    updateChart(data.dados);
                    updateInfoPanel(data);
                    document.getElementById("loading").style.display = "none";
                } else { setTimeout(loadInitialData, 5000); }
            }).catch(error => { setTimeout(loadInitialData, 5000); });
        }
        function setupWebSocket() {
            socket.on("connect", function() {
                document.getElementById("magneticStatus").className = "status-indicator status-active";
                document.getElementById("magneticStatusText").textContent = "Conectado";
                solicitarDados();
            });
            socket.on("disconnect", function() {
                document.getElementById("magneticStatus").className = "status-indicator status-inactive";
                document.getElementById("magneticStatusText").textContent = "Desconectado";
            });
            socket.on("dados_atualizados", function(data) {
                updateChart(data.dados);
                updateInfoPanel(data.analise);
                document.getElementById("loading").style.display = "none";
            });
        }
        document.addEventListener("DOMContentLoaded", function() {
            initializeChart();
            setupWebSocket();
            loadInitialData();
            setInterval(() => { if (socket.connected && autoUpdate) { solicitarDados(); } }, 10000);
        });
    </script>
</body>
</html>
